#!/bin/bash
# claude-sudo - Run Claude Code with sudo access
# https://github.com/hugsband/claude-sudo-tools
#
# Authenticates once via GUI prompt, maintains credentials for session duration.
# Version: 1.0.0

set -euo pipefail

VERSION="1.0.0"
ASKPASS="/usr/local/bin/claude-askpass"
KEEPALIVE_INTERVAL=240  # 4 minutes (well under default timeout)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

show_help() {
    cat << 'EOF'
claude-sudo - Run Claude Code with sudo access

USAGE
    claude-sudo [OPTIONS] [CLAUDE_ARGS...]

DESCRIPTION
    Launches Claude Code with sudo access enabled. Authenticates once via
    GUI password prompt, then maintains credentials for the session duration.

OPTIONS
    -h, --help      Show this help message
    -v, --version   Show version number

EXAMPLES
    claude-sudo                  Start Claude with sudo access
    claude-sudo /path/to/project Start in specific directory
    claude-sudo --help           Show this help

HOW IT WORKS
    1. Prompts for password via GUI dialog (kdialog/zenity/yad)
    2. Caches sudo credentials (default 90 minutes)
    3. Background process refreshes credentials every 4 minutes
    4. On exit, cleanup process terminates keepalive

TROUBLESHOOTING
    If prompted for password on every command:
        sudo visudo -f /etc/sudoers.d/claude-sudo
        Add: Defaults:YOUR_USER !tty_tickets

    See: https://github.com/hugsband/claude-sudo-tools/blob/main/docs/TROUBLESHOOTING.md

EOF
}

show_version() {
    echo "claude-sudo version $VERSION"
}

# Parse arguments
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    -v|--version)
        show_version
        exit 0
        ;;
esac

# Verify askpass exists
if [[ ! -x "$ASKPASS" ]]; then
    echo -e "${RED}ERROR: claude-askpass not found at $ASKPASS${NC}" >&2
    echo "" >&2
    echo "Run the installer first:" >&2
    echo "  git clone https://github.com/hugsband/claude-sudo-tools.git" >&2
    echo "  cd claude-sudo-tools && ./scripts/install.sh" >&2
    exit 1
fi

export SUDO_ASKPASS="$ASKPASS"

# Check if already authenticated
if sudo -n true 2>/dev/null; then
    echo -e "${GREEN}Already authenticated.${NC}"
else
    echo "Authenticating for sudo access..."
    if ! sudo -A -v; then
        echo -e "${RED}Authentication failed or cancelled.${NC}" >&2
        exit 1
    fi
    echo -e "${GREEN}Authentication successful.${NC}"
fi

# Background keepalive process
keepalive() {
    while true; do
        sleep $KEEPALIVE_INTERVAL
        # Use -A to trigger askpass if credentials expired
        sudo -A -v 2>/dev/null || exit 0
    done
}
keepalive &
KEEPALIVE_PID=$!

# Cleanup function
cleanup() {
    kill $KEEPALIVE_PID 2>/dev/null || true
}
trap cleanup EXIT INT TERM HUP

# Run Claude Code with all passed arguments
exec claude "$@"
